# 青岛OJ系统架构调研报告

## 1. 技术栈版本信息

### 1.1 后端技术栈
- **Python版本**: 3.8.10
- **Django版本**: 4.2.23 (运行时) / 3.2.25 (requirements.txt)
- **Django REST Framework**: 3.14.0
- **数据库**: PostgreSQL (psycopg2 2.9.9, psycopg2-binary 2.9.10)
- **缓存**: Redis (django-redis 5.4.0)
- **任务队列**: Celery (相关依赖已安装)
- **其他关键依赖**:
  - gunicorn: WSGI服务器
  - dramatiq: 任务队列处理
  - requests: HTTP请求库

### 1.2 前端技术栈
- **Node.js版本**: v18.20.8
- **npm版本**: 10.8.2
- **Vue.js版本**: 2.5.16
- **UI框架**: 
  - Element UI: 2.3.7
  - iView: 2.13.0
- **状态管理**: Vuex 3.0.1
- **路由**: Vue Router 3.0.1
- **HTTP客户端**: Axios 0.18.0
- **构建工具**: Webpack 3.6.0

## 2. 项目结构分析

### 2.1 后端项目结构
```
OnlineJudge/
├── account/          # 用户账户管理
├── announcement/     # 公告管理
├── choice_question/  # 选择题模块(已创建)
├── conf/            # 系统配置
├── contest/         # 竞赛管理
├── judge/           # 判题系统
├── oj/              # 项目配置
├── problem/         # 题目管理
├── submission/      # 提交记录
└── utils/           # 工具类
```

### 2.2 前端项目结构
```
OnlineJudgeFE/src/
├── pages/
│   ├── oj/          # OJ前台页面
│   │   ├── components/  # 公共组件
│   │   ├── views/       # 页面视图
│   │   ├── router/      # 路由配置
│   │   └── api.js       # API接口
│   └── admin/       # 管理后台页面
├── store/           # Vuex状态管理
├── i18n/            # 国际化
├── styles/          # 样式文件
└── utils/           # 工具函数
```

## 3. 核心代码规范分析

### 3.1 Model层设计规范

#### 数据模型特点:
- 使用Django ORM，继承`models.Model`
- 统一使用`db_table`指定表名
- 字段类型规范:
  - `TextField`: 文本字段
  - `JSONField`: JSON数据存储
  - `DateTimeField`: 时间字段
  - `ForeignKey`: 外键关联
  - `ManyToManyField`: 多对多关联

#### Problem模型示例分析:
```python
class Problem(models.Model):
    _id = models.TextField(db_index=True)  # 显示ID，建立索引
    title = models.TextField()             # 题目标题
    description = RichTextField()          # 富文本描述
    samples = JSONField()                  # JSON格式样例
    tags = models.ManyToManyField(ProblemTag)  # 多对多标签关联
    
    class Meta:
        db_table = "problem"
        unique_together = (("_id", "contest"),)  # 联合唯一约束
        ordering = ("create_time",)              # 默认排序
```

### 3.2 API层设计规范

#### API基类设计:
- 继承`utils.api.APIView`基类
- 统一的请求解析和响应格式
- 标准化的成功/错误响应:
  - `self.success(data)`: 成功响应
  - `self.error(msg, err)`: 错误响应
  - `self.paginate_data()`: 分页处理

#### API视图示例:
```python
class ProblemAPI(APIView):
    def get(self, request):
        # 获取参数
        problem_id = request.GET.get("problem_id")
        
        # 业务逻辑处理
        if problem_id:
            # 单个问题详情
            problem = Problem.objects.get(_id=problem_id)
            return self.success(ProblemSerializer(problem).data)
        
        # 问题列表
        problems = Problem.objects.filter(visible=True)
        data = self.paginate_data(request, problems, ProblemSerializer)
        return self.success(data)
```

### 3.3 权限认证系统

#### 用户模型设计:
- 继承`AbstractBaseUser`
- 用户类型: `REGULAR_USER`, `ADMIN`, `SUPER_ADMIN`
- 权限控制: `problem_permission`字段
- 认证方式: 支持用户名密码、SSO、双因子认证

#### 权限装饰器:
- `@check_contest_permission`: 竞赛权限检查
- 路由级权限控制: `meta.requiresAuth`

## 4. 前端开发规范

### 4.1 组件使用规范

#### 全局组件:
- `Panel`: 面板组件
- `VerticalMenu/VerticalMenuItem`: 垂直菜单
- `ECharts`: 图表组件
- `CodeMirror`: 代码编辑器

#### UI框架使用:
- 主要使用iView组件库
- Element UI作为补充
- 统一的Loading和Message提示

### 4.2 路由设计规范

#### 路由配置特点:
- 使用`history`模式
- 全局路由守卫进行身份验证
- 嵌套路由支持(如contest子路由)
- 路由元信息包含标题和权限要求

#### 典型路由结构:
```javascript
{
  name: 'problem-list',
  path: '/problem',
  meta: {title: 'Problem List'},
  component: ProblemList
}
```

### 4.3 样式规范
- 使用Less预处理器
- 全局样式文件: `@/styles/index.less`
- 组件级样式作用域

## 5. 数据库配置

### 5.1 数据库设置
- **主数据库**: PostgreSQL
- **配置方式**: 环境变量配置
  - `POSTGRES_HOST`: 数据库主机
  - `POSTGRES_PORT`: 端口
  - `POSTGRES_DB`: 数据库名
  - `POSTGRES_USER`: 用户名
  - `POSTGRES_PASSWORD`: 密码

### 5.2 缓存配置
- **缓存后端**: Redis
- **配置**: `REDIS_URL`环境变量
- **用途**: 会话存储、数据缓存

## 6. 国际化支持
- 前端使用Vue i18n
- 后端支持多语言
- iView组件库集成i18n

## 7. 开发环境配置
- **调试模式**: `DEBUG = True` (开发环境)
- **允许的主机**: `ALLOWED_HOSTS`配置
- **静态文件**: `DATA_DIR`配置

## 8. 选择题插件开发建议

### 8.1 后端开发建议
1. **应用结构**: 已创建`choice_question`应用，需要完善模型和视图
2. **数据模型设计**: 参考`Problem`模型设计选择题相关模型
3. **API设计**: 继承`APIView`基类，遵循现有API规范
4. **权限集成**: 复用现有用户权限系统

### 8.2 前端开发建议
1. **组件开发**: 在`src/pages/oj/views/`下创建选择题相关页面
2. **路由配置**: 在路由配置中添加选择题相关路由
3. **API集成**: 在`api.js`中添加选择题相关接口
4. **UI组件**: 复用现有iView和Element UI组件

### 8.3 集成要点
1. **数据库迁移**: 使用Django migrations管理数据库变更
2. **URL配置**: 在主URL配置中包含选择题应用路由
3. **权限控制**: 集成现有权限系统
4. **国际化**: 添加多语言支持

## 9. 总结

青岛OJ系统采用Django + Vue.js的前后端分离架构，技术栈相对成熟稳定。系统具有良好的模块化设计，为选择题插件的开发提供了良好的基础。建议在开发选择题插件时严格遵循现有的代码规范和架构模式，确保与主系统的良好集成。