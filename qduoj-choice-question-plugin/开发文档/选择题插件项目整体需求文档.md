# 📘 青岛OJ选择题插件开发文档（插件化·独立目录版）
## 一、项目总体目标
基于**青岛OJ（QDUOJ）系统**开发**独立目录结构的选择题功能插件**，核心目标如下：
1. **插件独立性**：后端、前端均采用独立目录开发，不修改OJ核心代码，仅通过插件接口与原系统交互；
2. **无缝集成性**：UI风格、用户体系、权限系统、数据统计完全对齐原OJ，无“第三方插件”割裂感；
3. **完整功能性**：支持单选/多选题、多级分类、标签管理、错题本、批量导入导出等核心功能；
4. **可插拔性**：支持一键安装、卸载、升级，安装时自动完成数据库迁移，卸载时清理残留数据；
5. **低耦合性**：通过原OJ的插件扩展接口（或动态注入方式）实现集成，不依赖原OJ核心代码修改。


## 二、插件目录结构设计（核心：独立目录）
插件根目录统一为 `qduoj-choice-plugin/`，内部按“后端-前端-部署脚本”分离，目录结构如下：
```
qduoj-choice-plugin/
├── backend/                # 后端插件目录（独立Django App）
│   ├── choice_plugin/      # 插件核心模块
│   │   ├── __init__.py
│   │   ├── plugin.py       # 插件入口（声明元信息、生命周期钩子）
│   │   ├── apps.py         # Django App配置（独立注册）
│   │   ├── models/         # 插件独立数据模型（不修改原OJ表）
│   │   │   ├── __init__.py
│   │   │   ├── category.py # 分类模型
│   │   │   ├── question.py # 题目模型
│   │   │   └── wrong_book.py # 错题本模型
│   │   ├── api/            # 插件独立API（带插件前缀）
│   │   │   ├── __init__.py
│   │   │   ├── serializers.py # 序列化器
│   │   │   ├── views.py    # API视图
│   │   │   └── urls.py     # 插件内部URL（不修改原OJ路由）
│   │   ├── migrations/     # 插件独立数据库迁移文件
│   │   └── utils/          # 插件工具类（如导入导出、判题逻辑）
│   ├── requirements.txt    # 插件后端依赖（如django-mptt、django-taggit）
│   ├── setup.py            # 插件安装脚本（支持pip install）
│   └── uninstall.py        # 插件卸载脚本（清理数据库、配置）
│
├── frontend/               # 前端插件目录（独立Vue模块）
│   ├── src/
│   │   ├── plugin-entry.js # 前端插件入口（声明路由、菜单、生命周期）
│   │   ├── api/            # 插件API封装（请求带插件前缀）
│   │   ├── components/     # 插件独立组件（如分类树、标签云）
│   │   ├── views/          # 插件页面（题目列表、答题页、错题本）
│   │   │   ├── ChoiceList.vue
│   │   │   ├── ChoiceDetail.vue
│   │   │   └── WrongBook.vue
│   │   ├── store/          # 插件独立状态管理（不污染原OJ Vuex）
│   │   └── styles/         # 插件样式（复用原OJ变量，避免冲突）
│   ├── package.json        # 前端依赖声明
│   └── vue.config.js       # 前端构建配置（输出为插件可用资源）
│
└── plugin.json             # 插件元信息（名称、版本、作者、依赖OJ版本、入口文件）
```


## 三、核心功能需求（插件内实现，不依赖原OJ核心）
| 功能模块       | 具体功能点                                                                 | 实现说明（插件化特性）                                                                 |
|----------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------------------|
| 1. 题目管理     | 单选/多选题创建/编辑/删除、难度设置、批量导入导出（Excel/CSV）、题目审核发布 | 插件内独立实现，题目数据存储在插件专属表，通过API与原OJ用户关联（外键User）          |
| 2. 多级分类管理 | 分类增删改、树形结构（拖拽排序）、分类下题目统计、批量移动题目             | 用Django MPTT实现树形结构，分类数据存储在插件表，前端用独立组件渲染分类树            |
| 3. 标签管理     | 标签增删改、颜色设置、热门标签统计、题目批量添删标签、标签云展示           | 插件内建Tag模型，热门标签统计通过插件内缓存（Redis）实现，不依赖原OJ标签系统        |
| 4. 答题功能     | 题目列表（分页/筛选/搜索）、答题界面、实时判题、答题记录、题目收藏         | 答题记录存储在插件表，判题逻辑在插件内实现，收藏功能关联原OJ用户但不修改原用户表    |
| 5. 错题本       | 自动记录错题、分类/标签/时间筛选、错题笔记、重做统计、PDF导出、相似题推荐   | 错题数据独立存储，相似题推荐算法在插件内实现，导出功能不依赖原OJ工具类              |
| 6. 统计分析     | 个人答题统计、分类/标签正确率、答题趋势图、排行榜（总榜/分类榜）           | 统计数据缓存于插件Redis键（带插件前缀），图表用独立ECharts组件，排行榜独立计算      |
| 7. 插件管理     | 安装检测、版本查询、卸载清理、升级兼容                                     | 通过`plugin.json`和安装脚本实现，卸载时自动删除插件表、路由、菜单残留                |


## 四、任务拆解（分阶段：插件架构→功能开发→集成→部署）
### 阶段1：插件基础架构搭建（优先保障独立目录与可插拔）
#### 1.1 后端插件基础（独立目录初始化）
```markdown
任务1.1.1：创建插件后端目录
- 新建 `qduoj-choice-plugin/backend/` 目录，初始化Django App（命名为`choice_plugin`）
- 在 `choice_plugin/` 下创建 `plugin.py`（插件入口文件），声明元信息：
  ```python
  # choice_plugin/plugin.py
  PLUGIN_META = {
      "name": "qduoj-choice-question",
      "version": "1.0.0",
      "author": "xxx",
      "oj_version_require": ">=2.0.0",  # 依赖的OJ版本
      "description": "青岛OJ选择题功能插件",
      "backend_entry": "choice_plugin.apps.ChoicePluginConfig",  # Django App入口
      "uninstall_clean": ["choice_plugin_*"],  # 卸载时清理的表前缀
  }
  ```
- 配置 `choice_plugin/apps.py`，使用Django AppConfig实现插件注册（不修改原OJ settings）：
  ```python
  from django.apps import AppConfig

  class ChoicePluginConfig(AppConfig):
      default_auto_field = "django.db.models.BigAutoField"
      name = "choice_plugin"
      verbose_name = "选择题插件"

      # 插件启动时执行（如注册信号、初始化缓存）
      def ready(self):
          import choice_plugin.signals  # 插件信号（如用户删除时清理错题）
  ```
- 编写 `backend/requirements.txt`，声明插件依赖（避免冲突）：
  ```txt
  django>=3.2,<4.0  # 对齐原OJ Django版本
  djangorestframework>=3.13.0
  django-mptt==0.14.0  # 多级分类
  django-taggit==3.1.0  # 标签
  openpyxl==3.1.2  # Excel导入导出
  ```

任务1.1.2：后端依赖与数据库配置
- 声明插件数据库策略：**独立表，不修改原OJ表**，外键关联原OJ User表：
  ```python
  # choice_plugin/models/base.py（插件基础模型，所有模型继承此类）
  from django.db import models
  from django.contrib.auth.models import User  # 关联原OJ用户表，不修改

  class PluginBaseModel(models.Model):
      created_at = models.DateTimeField(auto_now_add=True, verbose_name="创建时间")
      updated_at = models.DateTimeField(auto_now=True, verbose_name="更新时间")

      class Meta:
          abstract = True  # 抽象模型，不生成独立表
  ```
- 配置插件数据库迁移：在 `backend/` 下编写 `migrate.sh`，实现安装时自动迁移：
  ```bash
  # backend/migrate.sh
  # 切换到OJ项目根目录，执行插件迁移（假设OJ根目录为../qduoj/）
  cd ../qduoj/
  python manage.py makemigrations choice_plugin --empty
  python manage.py migrate choice_plugin
  echo "插件数据库迁移完成"
  ```
```

#### 1.2 前端插件基础（独立目录与入口）
```markdown
任务1.2.1：创建插件前端目录
- 新建 `qduoj-choice-plugin/frontend/` 目录，初始化前端项目：
  ```bash
  cd qduoj-choice-plugin/frontend/
  npm init -y
  npm install vue@2.x vue-router@3.x axios echarts element-ui  # 对齐原OJ前端版本
  ```
- 创建 `src/plugin-entry.js`（前端插件入口，供OJ动态加载）：
  ```javascript
  // 前端插件元信息与生命周期
  export const ChoicePlugin = {
    meta: {
      name: "qduoj-choice-question",
      version: "1.0.0",
      frontendAssets: ["/plugin/choice/css/main.css", "/plugin/choice/js/main.js"],  // 构建后资源路径
    },
    // OJ加载插件时执行：注册路由、菜单
    install(Vue, { router, menuService }) {
      // 1. 动态添加路由（不修改原OJ router/index.js）
      router.addRoute("oj", {  // 挂载到OJ的"oj"路由下
        path: "/plugin/choice/questions",
        name: "ChoiceQuestionList",
        component: () => import("./views/ChoiceList.vue"),
        meta: { title: "选择题题库", permission: "choice:view" }  // 插件自定义权限
      });
      // 2. 注入菜单（通过OJ的菜单服务，不修改原OJ菜单配置）
      menuService.addMenu({
        parentKey: "problem",  // 父菜单：原OJ的"题库"
        key: "choice-question",
        title: "选择题",
        icon: "el-icon-edit-outline",
        path: "/plugin/choice/questions",
        permission: "choice:view"
      });
    },
    // OJ卸载插件时执行：清理路由、菜单
    uninstall(Vue, { router, menuService }) {
      router.removeRoute("ChoiceQuestionList");
      menuService.removeMenu("choice-question");
    }
  };

  // 暴露插件供OJ加载
  if (window.OJPlugin) {
    window.OJPlugin.register(ChoicePlugin);
  }
  ```
- 配置 `vue.config.js`，指定构建输出路径（便于OJ挂载插件资源）：
  ```javascript
  module.exports = {
    outputDir: "../dist/frontend",  // 构建后输出到插件根目录的dist
    assetsDir: "static",
    publicPath: "/plugin/choice/",  // 资源访问前缀（避免与原OJ冲突）
    configureWebpack: {
      output: {
        library: "ChoicePlugin",  // 打包为库，供OJ动态引入
        libraryTarget: "umd"
      }
    }
  };
  ```
```


### 阶段2：插件核心功能开发（独立实现，不依赖原OJ核心代码）
#### 2.1 后端功能开发（插件内独立实现）
```markdown
任务2.1.1：数据模型设计（插件独立表）
- 分类模型（`choice_plugin/models/category.py`）：
  ```python
  from django.db import models
  from mptt.models import MPTTModel, TreeForeignKey
  from .base import PluginBaseModel

  class Category(MPTTModel, PluginBaseModel):
      name = models.CharField(max_length=100, verbose_name="分类名称")
      parent = TreeForeignKey(
          "self", null=True, blank=True, on_delete=models.CASCADE, related_name="children", verbose_name="父分类"
      )
      order = models.IntegerField(default=0, verbose_name="排序")
      description = models.TextField(blank=True, verbose_name="描述")
      icon = models.CharField(max_length=50, blank=True, verbose_name="图标类名")
      question_count = models.IntegerField(default=0, verbose_name="题目数量")

      class MPTTMeta:
          order_insertion_by = ["order"]
          verbose_name = "选择题分类"
          verbose_name_plural = "选择题分类"

      class Meta:
          db_table = "choice_plugin_category"  # 表名带插件前缀，避免冲突
  ```
- 题目模型（`choice_plugin/models/question.py`）、错题本模型（`choice_plugin/models/wrong_book.py`）同理，均继承`PluginBaseModel`，表名带`choice_plugin_`前缀。

任务2.1.2：插件API开发（带插件前缀，避免冲突）
- 在 `choice_plugin/api/urls.py` 中定义插件API路由：
  ```python
  from django.urls import path
  from .views import CategoryViewSet, QuestionViewSet

  urlpatterns = [
      path("categories/", CategoryViewSet.as_view({"get": "list", "post": "create"}), name="choice-category"),
      path("questions/", QuestionViewSet.as_view({"get": "list", "post": "create"}), name="choice-question"),
      # 其他API...
  ]
  ```
- 在 `choice_plugin/plugin.py` 中声明API挂载点（供OJ动态添加）：
  ```python
  PLUGIN_META["api_urls"] = {
      "prefix": "/api/plugin/choice/",  # API前缀，避免与原OJ冲突
      "urls_module": "choice_plugin.api.urls"
  }
  ```
- API视图实现（`choice_plugin/api/views.py`）：复用DRF，但权限判断关联原OJ用户（如管理员权限通过`request.user.is_staff`判断）。
```

#### 2.2 前端功能开发（独立组件，复用OJ样式）
```markdown
任务2.2.1：核心页面开发（独立组件，不依赖原OJ组件目录）
- 题目列表页（`src/views/ChoiceList.vue`）：复用原OJ的Element UI组件，但通过独立API请求数据：
  ```vue
  <template>
    <div class="choice-list-page">
      <!-- 复用原OJ的Panel组件，保持UI一致 -->
      <el-panel title="选择题题库">
        <!-- 筛选区：分类+标签 -->
        <el-row :gutter="10">
          <el-col :span="8">
            <category-tree v-model="selectedCategory" />  <!-- 插件内组件 -->
          </el-col>
          <el-col :span="8">
            <tag-select v-model="selectedTags" />  <!-- 插件内组件 -->
          </el-col>
        </el-row>
        <!-- 题目表格 -->
        <el-table :data="questionList" border>
          <el-table-column label="题目" prop="title" />
          <el-table-column label="难度" prop="difficulty" />
          <el-table-column label="操作">
            <template #default="scope">
              <el-button @click="goToDetail(scope.row.id)">查看</el-button>
            </template>
          </el-table-column>
        </el-table>
      </el-panel>
    </div>
  </template>

  <script>
  import { getQuestionList } from "@/api/choice-api";  // 插件内API封装
  import CategoryTree from "@/components/CategoryTree.vue";  // 插件内组件
  export default {
    data() {
      return { questionList: [], selectedCategory: null, selectedTags: [] };
    },
    methods: {
      async fetchQuestions() {
        const res = await getQuestionList({ category: this.selectedCategory, tags: this.selectedTags });
        this.questionList = res.data;
      }
    }
  };
  </script>
  ```
- 错题本页面（`src/views/WrongBook.vue`）、答题详情页同理，均使用插件内组件和API。

任务2.2.2：前端状态管理（独立Vuex模块，不污染原OJ）
- 创建 `src/store/choice-store.js`：
  ```javascript
  const state = { wrongCount: 0 };
  const mutations = {
    SET_WRONG_COUNT(state, count) { state.wrongCount = count; }
  };
  const actions = {
    fetchWrongCount({ commit }, userId) {
      // 调用插件API获取错题数
      return axios.get("/api/plugin/choice/wrong-count/", { params: { user_id: userId } })
        .then(res => commit("SET_WRONG_COUNT", res.data.count));
    }
  };
  export default { namespaced: true, state, mutations, actions };  // 带命名空间，避免冲突
  ```
- 在 `plugin-entry.js` 中动态注册到原OJ的Vuex：
  ```javascript
  install(Vue, { store }) {
    store.registerModule("choicePlugin", import("./store/choice-store.js"));  // 注册命名空间模块
  }
  ```
```


### 阶段3：插件与OJ集成（动态挂载，不修改原OJ核心）
```markdown
任务3.1：后端集成（通过OJ插件接口或脚本动态注册）
- 若原OJ有插件注册机制：在OJ后台“插件管理”上传`plugin.json`，OJ自动加载`backend_entry`（Django App）和`api_urls`；
- 若OJ无插件机制：提供 `install_backend.sh` 脚本，通过Django命令动态添加App和API：
  ```bash
  # install_backend.sh
  # 1. 将插件后端目录链接到OJ的apps目录（避免复制）
  ln -s $(pwd)/backend/choice_plugin ../qduoj/apps/
  # 2. 动态添加App到OJ的settings.py（通过sed命令，卸载时反向删除）
  sed -i '/INSTALLED_APPS/a \    "apps.choice_plugin",' ../qduoj/conf/settings.py
  # 3. 动态添加API路由到OJ的主urls.py
  sed -i '/urlpatterns/a \path("api/plugin/choice/", include("apps.choice_plugin.api.urls")),\' ../qduoj/conf/urls.py
  # 4. 执行数据库迁移
  cd ../qduoj/ && python manage.py migrate choice_plugin
  ```

任务3.2：前端集成（动态加载资源与路由）
- 构建前端资源：
  ```bash
  cd frontend/ && npm run build  # 输出到 ../dist/frontend/
  ```
- 将构建后的资源挂载到OJ的静态目录：
  ```bash
  # install_frontend.sh
  # 1. 复制前端资源到OJ的static/plugin/choice/
  cp -r ../dist/frontend/static/* ../qduoj/static/plugin/choice/
  # 2. 在OJ的index.html中动态引入插件入口（卸载时删除）
  sed -i '</body>/i \    <script src="/static/plugin/choice/js/main.js"></script>' ../qduoj/templates/index.html
  ```
```


### 阶段4：插件安装/卸载/升级（完整生命周期）
```markdown
任务4.1：一键安装脚本（`install.sh`）
```bash
#!/bin/bash
# 插件一键安装脚本
echo "开始安装选择题插件..."

# 1. 安装后端依赖
cd backend/ && pip install -r requirements.txt
# 2. 执行后端集成
./install_backend.sh
# 3. 构建并集成前端
cd ../frontend/ && npm install && npm run build
../install_frontend.sh

echo "插件安装完成！访问OJ的「题库→选择题」即可使用"
```

任务4.2：一键卸载脚本（`uninstall.sh`）
```bash
#!/bin/bash
# 插件一键卸载脚本
echo "开始卸载选择题插件..."

# 1. 清理后端
cd backend/ && ./uninstall_backend.sh  # 反向执行install_backend.sh的操作
# 2. 清理前端资源
rm -rf ../qduoj/static/plugin/choice/
sed -i '/static\/plugin\/choice\/js\/main.js/d' ../qduoj/templates/index.html
# 3. 清理数据库表（根据plugin.json的uninstall_clean）
cd ../qduoj/ && python manage.py dbshell -c "DROP TABLE IF EXISTS choice_plugin_category, choice_plugin_question, choice_plugin_wrongbook;"

echo "插件卸载完成！"
```

任务4.3：版本升级脚本（`upgrade.sh`）
```bash
#!/bin/bash
# 插件升级脚本
echo "开始升级选择题插件..."

# 1. 拉取最新代码（假设用Git）
git pull
# 2. 升级后端依赖
cd backend/ && pip install -r requirements.txt --upgrade
# 3. 执行数据库迁移（处理版本差异）
cd ../qduoj/ && python manage.py migrate choice_plugin
# 4. 重构前端
cd ../frontend/ && npm install && npm run build
# 5. 刷新静态资源
cp -r ../dist/frontend/static/* ../qduoj/static/plugin/choice/

echo "插件升级完成！当前版本：$(cat plugin.json | jq -r '.version')"
```
```


## 五、调研任务补充（插件化相关，交给Trae）
在原有调研基础上，增加**插件集成关键信息**调研，避免集成时踩坑：
1. **原OJ的插件支持情况**：
   - OJ是否有官方插件注册机制（如`plugins/`目录、`PluginManager`类）？
   - OJ的`settings.py`是否支持通过环境变量或配置文件引入外部App？
   - OJ的主`urls.py`是否有动态路由注册接口（如`register_url_prefix`函数）？
2. **前端动态集成能力**：
   - OJ的Vue实例是否暴露全局挂载点（如`window.OJ`）？
   - OJ的菜单系统是否支持通过API注入菜单（如`menuService.add`）？
   - OJ的Vuex是否允许注册命名空间模块（避免冲突）？
3. **数据权限与安全**：
   - OJ的用户认证Token是否在所有请求头中携带（插件API需复用）？
   - OJ是否有自定义权限装饰器（如`@login_required`、`@admin_required`），插件能否直接使用？
4. **静态资源与构建**：
   - OJ的静态文件访问路径规则（如是否需要`STATIC_URL`前缀）？
   - OJ的前端构建工具（如Webpack）是否与插件兼容（版本、配置）？


## 六、验证要点（新增插件化特性检查）
| 验证模块       | 检查项                                                                 |
|----------------|-----------------------------------------------------------------------|
| 插件独立性     | 1. 插件目录是否完全独立，不修改原OJ核心文件？<br>2. 卸载后原OJ功能是否正常，无残留数据？ |
| 可插拔性       | 1. 执行`install.sh`能否一键安装成功？<br>2. 执行`uninstall.sh`能否完全清理？          |
| 功能完整性     | 1. 所有选择题功能是否正常（分类、答题、错题本）？<br>2. 数据统计是否与原OJ用户关联？    |
| 兼容性         | 1. 插件版本与OJ版本是否匹配（如Django/Vue版本）？<br>2. 插件API是否与原OJ接口无冲突？  |


## 七、使用建议
1. **开发顺序**：先完成“插件基础架构”（阶段1），确保目录独立、可挂载后，再开发核心功能（阶段2），避免后期重构；
2. **测试优先级**：优先测试“卸载功能”，确保插件不会破坏原OJ系统；
3. **版本管理**：每次迭代更新`plugin.json`的版本号，升级脚本通过版本号判断是否需要迁移数据；
4. **文档同步**：在插件根目录下保留`README.md`，说明安装步骤、功能清单、常见问题，便于其他用户使用。