# MetaSeekOJ 项目启动文档

## 项目概述

MetaSeekOJ 是一个基于 Django + Vue.js 的在线判题系统，支持编程题和选择题两种题型。系统采用前后端分离架构，使用 Docker 容器化部署，支持分布式判题和异步任务处理。

## 项目架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 (Vue.js)  │    │  后端 (Django)   │    │  判题服务器      │
│   Port: 8080    │◄──►│   Port: 8086    │◄──►│  Port: 8080     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       ▼                       │
         │              ┌─────────────────┐              │
         │              │  Redis 缓存     │              │
         │              │  Port: 6379     │              │
         │              └─────────────────┘              │
         │                       │                       │
         │                       ▼                       │
         │              ┌─────────────────┐              │
         └──────────────►│ PostgreSQL 数据库│◄─────────────┘
                        │  Port: 5432     │
                        └─────────────────┘
```

## 运行环境要求

### 系统环境
- **操作系统**: Ubuntu 20.04+ / WSL2
- **Docker**: 20.10+
- **Docker Compose**: 1.29+

### 开发环境
- **Python**: 3.8.10 (使用虚拟环境)
- **Node.js**: 20.19.0+
- **npm/yarn**: 最新版本

### 服务依赖
- **Redis**: 6.0+ (缓存和消息队列)
- **PostgreSQL**: 12+ (主数据库)
- **Nginx**: 1.18+ (反向代理，生产环境)

## 核心依赖

### 后端依赖 (Django)
```python
# 核心框架
Django==4.2.24
djangorestframework==3.14.0

# 异步任务处理
dramatiq==1.12.3
django-dramatiq==0.10.0

# 数据库和缓存
psycopg2-binary==2.9.3
redis==4.3.4
django-redis==5.2.0

# 其他工具
corsheaders==3.13.0
raven==6.10.0
django-dbconn-retry==0.1.7
```

### 前端依赖 (Vue.js)
```json
{
  "vue": "^2.5.16",
  "vue-router": "^3.0.1",
  "vuex": "^3.0.1",
  "element-ui": "^2.15.14",
  "axios": "^0.18.0",
  "webpack": "^3.6.0",
  "webpack-dev-server": "^2.11.5"
}
```

## 服务架构和端口配置

| 服务名称 | 容器名称 | 端口映射 | 说明 |
|---------|---------|---------|------|
| 前端服务 | - | 8080 | Vue.js 开发服务器 |
| 后端API | oj-backend | 8086 | Django REST API |
| 判题服务器 | onlinejudgedeploy-oj-judge-1 | 172.20.0.3:8080 | 代码判题服务 |
| Redis缓存 | oj-redis | 6379 | 缓存和消息队列 |
| PostgreSQL | oj-postgres | 5432 | 主数据库 |
| Dramatiq Worker | oj-backend | - | 异步任务处理 |

## 启动方式

### 方式一：SOLO模式启动（推荐开发）

SOLO模式提供启动命令而不自动执行，适合开发调试。

#### 1. 停止现有服务
```bash
pkill -f "python manage.py runserver"
pkill -f "npm run dev"
```

#### 2. 启动Redis服务
```bash
# 检查Redis状态
redis-cli ping

# 如果未启动，启动Redis
redis-server --daemonize yes
```

#### 3. 启动后端服务
```bash
cd /home/metaspeekoj/OnlineJudge
source django_env/bin/activate
python manage.py runserver 0.0.0.0:8086
```

#### 4. 启动前端服务（新终端）
```bash
cd /home/metaspeekoj/OnlineJudgeFE
npm run dev
```

### 方式二：Docker Compose启动

```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

### 方式三：一键脚本启动

```bash
# 使用项目启动脚本
./start_project.sh

# 或使用Python重启脚本
python3 /home/metaspeekoj/mcp-servers/restart_project.py
```

## 详细启动步骤

### 第一次启动准备

1. **克隆项目**
```bash
git clone <repository-url>
cd metaspeekoj
```

2. **安装后端依赖**
```bash
cd OnlineJudge
python3 -m venv django_env
source django_env/bin/activate
pip install -r requirements.txt
```

3. **安装前端依赖**
```bash
cd ../OnlineJudgeFE
npm install
```

4. **配置数据库**
```bash
cd ../OnlineJudge
source django_env/bin/activate
python manage.py migrate
python manage.py collectstatic
```

5. **创建超级用户**
```bash
python manage.py createsuperuser
```

### 日常开发启动

1. **启动Docker服务**
```bash
docker-compose up -d oj-redis oj-postgres
```

2. **启动后端**
```bash
cd OnlineJudge
source django_env/bin/activate
python manage.py runserver 0.0.0.0:8086
```

3. **启动前端**
```bash
cd OnlineJudgeFE
npm run dev
```

4. **启动判题服务（如需要）**
```bash
docker-compose up -d oj-judge
```

## 服务验证

### 检查服务状态
```bash
# 检查Redis
redis-cli ping
# 预期输出: PONG

# 检查后端API
curl -I http://localhost:8086/api/
# 预期输出: HTTP/1.1 200 OK

# 检查前端
curl -I http://localhost:8080
# 预期输出: HTTP/1.1 200 OK

# 检查数据库连接
cd OnlineJudge && source django_env/bin/activate
python manage.py dbshell
```

### 检查Docker容器
```bash
# 查看所有容器状态
docker ps

# 检查判题服务器
docker inspect onlinejudgedeploy-oj-judge-1 | grep IPAddress

# 测试判题服务器连接
curl -X POST http://172.20.0.3:8080/judge -H "Content-Type: application/json" -d '{}'
```

### 访问地址
- **前端界面**: http://localhost:8080
- **后端API**: http://localhost:8086
- **管理后台**: http://localhost:8086/admin
- **API文档**: http://localhost:8086/api/docs

## 常见问题排查

### 1. 端口占用问题
```bash
# 查看端口占用
netstat -tulpn | grep :8080
netstat -tulpn | grep :8086

# 杀死占用进程
sudo kill -9 <PID>
# 或使用进程名杀死
kill <PID>
```

**常见情况**:
- 前端服务启动时提示 `EADDRINUSE: address already in use 0.0.0.0:8080`
- 解决方案：先查找占用端口的进程ID，然后终止该进程
- 示例：`netstat -tulpn | grep :8080` 找到PID后执行 `kill <PID>`

### 2. Redis连接失败
```bash
# 检查Redis服务
sudo systemctl status redis

# 重启Redis
sudo systemctl restart redis

# 或使用Docker启动
docker-compose up -d oj-redis
```

### 3. 数据库连接问题
```bash
# 检查PostgreSQL容器
docker logs oj-postgres

# 重启数据库容器
docker-compose restart oj-postgres
```

### 4. 判题服务器连接问题
```bash
# 检查判题服务器状态
docker ps | grep judge

# 查看判题服务器日志
docker logs onlinejudgedeploy-oj-judge-1

# 更新判题服务器配置
cd OnlineJudge && source django_env/bin/activate
python manage.py shell
# 在shell中执行:
# from conf.models import JudgeServer
# server = JudgeServer.objects.get(id=1)
# server.service_url = 'http://172.20.0.3:8080'
# server.save()
```

### 5. 前端编译错误
```bash
# 清除缓存重新安装
cd OnlineJudgeFE
rm -rf node_modules package-lock.json
npm install

# 检查Node.js版本
node --version
npm --version
```

### 6. 权限问题
```bash
# 修复文件权限
sudo chown -R $USER:$USER /home/metaspeekoj/

# 修复Python虚拟环境权限
cd OnlineJudge
sudo chown -R $USER:$USER django_env/
```

## 开发调试指南

### 后端调试
```bash
# 启用Django调试模式
export DEBUG=True

# 查看详细日志
tail -f /home/metaspeekoj/OnlineJudge/data/log/oj.log

# 使用Django shell调试
python manage.py shell

# 运行测试
python manage.py test
```

### 前端调试
```bash
# 启用详细日志
npm run dev -- --verbose

# 构建生产版本
npm run build

# 分析打包大小
npm run build -- --analyze
```

### 数据库调试
```bash
# 查看数据库迁移状态
python manage.py showmigrations

# 创建新迁移
python manage.py makemigrations

# 应用迁移
python manage.py migrate

# 重置数据库（谨慎使用）
python manage.py flush
```

### 异步任务调试
```bash
# 查看Dramatiq任务队列
cd OnlineJudge && source django_env/bin/activate
python manage.py shell
# 在shell中查看待处理任务:
# from submission.models import Submission
# Submission.objects.filter(result=-2).count()

# 手动处理判题任务
# from judge.tasks import judge_task
# judge_task.send(<submission_id>)
```

## 性能优化建议

### 开发环境优化
1. 使用SSD硬盘提高I/O性能
2. 分配足够的内存给Docker（建议8GB+）
3. 启用Docker BuildKit加速构建
4. 使用本地Redis而非Docker容器（开发时）

### 生产环境部署
1. 使用Nginx反向代理
2. 启用Redis持久化
3. 配置数据库连接池
4. 启用静态文件CDN
5. 配置日志轮转

---

**文档版本**: v1.0  
**最后更新**: 2025-01-19  
**维护者**: MetaSeekOJ开发团队  

如有问题，请查看项目Wiki或提交Issue。