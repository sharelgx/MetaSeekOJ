# OnlineJudge 判题系统安装配置指导

## 当前状态分析

经过系统检查和配置，当前状态如下：

### ✅ 已完成配置
- **Judger Sandbox**: 已通过Docker容器运行 (`oj-judge-new`)
- **JudgeServer**: 已部署并运行在容器中 (IP: 172.17.0.4:8080)
- **Dramatiq任务队列**: 已配置并运行 (5个worker进程)
- **Django后端**: 正常运行在8086端口
- **django_dramatiq**: 已启用并完成数据库迁移
- **判题服务器连接**: 已配置正确的服务器地址

### ✅ 验证结果
- 判题服务器状态: **normal** ✓
- 服务器连接: **正常响应** ✓
- 任务队列: **正常运行** ✓
- 数据库: **已完成迁移** ✓

## 完整安装配置方案

### ✅ 第一步：启用django_dramatiq (已完成)

1. 编辑 `/home/metaspeekoj/OnlineJudge/oj/settings.py`
```python
# ✓ 已在第39行启用
VENDOR_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.sessions',
    'django.contrib.contenttypes',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',
    'django_dramatiq',  # ✓ 已启用
    'django_dbconn_retry',
    'corsheaders',
]
```

2. 重启Django服务
```bash
# ✓ 已重启并正常运行在8086端口
cd /home/metaspeekoj/OnlineJudge
source django_env/bin/activate
python manage.py runserver 0.0.0.0:8086
```

### ✅ 第二步：配置判题服务器连接 (已完成)

✓ 已配置判题服务器：
   - **主机名**: oj-judge-new
   - **IP地址**: 172.17.0.4
   - **服务URL**: http://172.17.0.4:8080
   - **状态**: normal
   - **CPU核心数**: 4
   - **连接状态**: 正常响应

### ✅ 第三步：验证判题服务器连接 (已完成)

1. 检查判题服务器状态
```bash
# ✓ 判题服务器容器正常运行
docker logs oj-judge-new --tail 50

# ✓ 判题服务器进程正常
docker exec oj-judge-new ps aux

# ✓ 服务器连接测试通过
curl -X POST http://172.17.0.4:8080/ping
```

2. 在Django shell中验证配置
```python
# ✓ 验证结果：
# - 判题服务器状态: normal
# - 服务器连接: 正常响应
# - Dramatiq任务队列: 5个worker正常运行
from conf.models import JudgeServer
from options.options import SysOptions

servers = JudgeServer.objects.all()
for server in servers:
    print(f"Server: {server.hostname}, Status: {server.status}")
```

### ✅ 第四步：测试判题功能 (系统已就绪)

判题系统现已完全配置并可以正常工作！

#### 当前系统状态
```
✓ 用户数量: 1
✓ 题目数量: 268
✓ 历史提交: 3
✓ 判题服务器: 1个 (状态: normal)
✓ 任务队列: 5个worker进程运行中
```

#### 如何测试判题功能

1. **通过Web界面测试**
   - 访问: http://localhost:8080
   - 登录系统
   - 选择任意题目
   - 提交代码
   - 系统将自动调用判题服务

2. **通过Django shell测试**
```python
# 创建测试提交
from submission.models import Submission
from problem.models import Problem
from account.models import User
from judge.tasks import judge_task

# 获取测试数据
user = User.objects.first()
problem = Problem.objects.first()

if user and problem:
    submission = Submission.objects.create(
        problem=problem,
        user=user,
        code='print("Hello World")',
        language='Python3',
        result=6  # 等待判题
    )
    
    # 发送判题任务
    judge_task.send(submission.id)
    print(f"✓ 测试提交已创建: {submission.id}")
```

3. **监控判题过程**
```bash
# 查看dramatiq worker日志
ps aux | grep dramatiq

# 查看判题服务器日志
docker logs oj-judge-new --tail 20
```

## 判题服务器详细配置

### 判题服务器组件说明

1. **Judger Sandbox** (https://github.com/QingdaoU/Judger)
   - 基于Seccomp的安全沙箱
   - 限制程序运行权限
   - 提供资源限制和安全隔离

2. **JudgeServer** (https://github.com/QingdaoU/JudgeServer)
   - 判题服务器主程序
   - 提供HTTP API接口
   - 管理判题任务队列

### 判题服务器配置文件

判题服务器的配置通常在以下位置：
- `/var/judger/code/judge/server.py` - 主服务程序
- `/var/judger/code/judge/runner.py` - 判题执行器
- `/etc/supervisord.conf` - 进程管理配置

### 网络配置

确保以下端口可访问：
- **12358**: 判题服务器HTTP API端口
- **6379**: Redis端口（任务队列）
- **5432**: PostgreSQL端口（如使用）

## 故障排除

### 常见问题

1. **提交状态一直为PENDING**
   - 检查dramatiq worker是否运行
   - 检查判题服务器是否可访问
   - 验证认证token是否正确

2. **判题服务器连接失败**
   - 检查防火墙设置
   - 验证IP地址和端口
   - 检查Docker网络配置

3. **编译错误**
   - 检查编程语言配置
   - 验证编译器是否安装
   - 查看详细错误信息

### 日志查看

```bash
# Django应用日志
tail -f /home/metaspeekoj/OnlineJudge/data/log/django.log

# 判题服务器日志
docker exec oj-judge-new tail -f /var/judger/code/judge/log/judger_server.log

# Dramatiq任务队列日志
ps aux | grep dramatiq
```

## 性能优化建议

1. **增加判题服务器数量**
   - 部署多个判题服务器实例
   - 配置负载均衡

2. **优化任务队列**
   - 调整dramatiq worker数量
   - 配置任务优先级

3. **监控和告警**
   - 设置服务器状态监控
   - 配置异常告警机制

## 安全注意事项

1. **网络安全**
   - 限制判题服务器访问权限
   - 使用强认证token
   - 配置防火墙规则

2. **资源限制**
   - 设置合理的CPU和内存限制
   - 配置磁盘空间限制
   - 防止恶意代码攻击

---

完成以上配置后，OnlineJudge系统应该能够正常处理代码提交和判题任务。如遇到问题，请参考故障排除部分或查看相关日志文件。