<!DOCTYPE html>
<html>
<head>
    <title>管理员权限诊断工具</title>
    <meta charset="utf-8">
</head>
<body>
    <h1>🔍 管理员权限诊断工具</h1>
    
    <div id="results"></div>
    
    <h2>手动操作</h2>
    <button onclick="checkUserStatus()">1. 检查用户状态</button>
    <button onclick="navigateToTopicManagement()">2. 导航到专题管理</button>
    <button onclick="checkRoutes()">3. 检查路由状态</button>
    <button onclick="clearCacheAndReload()">4. 清除缓存并重载</button>
    
    <script>
        function log(message) {
            const results = document.getElementById('results');
            results.innerHTML += '<p>' + new Date().toLocaleTimeString() + ': ' + message + '</p>';
            console.log(message);
        }
        
        function checkUserStatus() {
            try {
                log('=== 检查用户状态 ===');
                const app = document.querySelector('#app').__vue__;
                const store = app.$store;
                
                log('Store 状态:');
                log('- user: ' + JSON.stringify(store.getters.user));
                log('- 认证状态: ' + store.getters.isAuthenticated);
                log('- 管理员权限: ' + store.getters.isAdminRole);
                log('- 超级管理员: ' + store.getters.isSuperAdmin);
                
                log('当前路由: ' + window.location.href);
                log('Hash: ' + window.location.hash);
                
                return store.getters.user;
            } catch (e) {
                log('错误: ' + e.message);
                return null;
            }
        }
        
        function navigateToTopicManagement() {
            log('=== 导航到专题管理 ===');
            
            // 方法1: 使用 Vue Router
            try {
                const app = document.querySelector('#app').__vue__;
                app.$router.push({name: 'topic-management'});
                log('✅ 使用 Vue Router 导航');
            } catch (e) {
                log('Vue Router 导航失败: ' + e.message);
                
                // 方法2: 直接修改 hash
                window.location.hash = '#/topic/management';
                log('✅ 使用 hash 导航');
            }
            
            setTimeout(() => {
                log('导航后的 URL: ' + window.location.href);
            }, 1000);
        }
        
        function checkRoutes() {
            log('=== 检查路由状态 ===');
            
            try {
                const app = document.querySelector('#app').__vue__;
                const router = app.$router;
                
                log('当前路由对象: ' + JSON.stringify(router.currentRoute));
                log('路由历史: ' + JSON.stringify(router.history.current));
                
                // 检查专题管理路由是否存在
                const routes = router.options.routes;
                log('可用路由数量: ' + routes.length);
                
                // 查找专题管理相关路由
                routes.forEach(route => {
                    if (route.children) {
                        route.children.forEach(child => {
                            if (child.path.includes('topic') || child.name && child.name.includes('topic')) {
                                log('找到专题相关路由: ' + child.name + ' -> ' + child.path);
                            }
                        });
                    }
                });
                
            } catch (e) {
                log('检查路由失败: ' + e.message);
            }
        }
        
        function clearCacheAndReload() {
            log('=== 清除缓存并重载 ===');
            
            // 清除 localStorage
            if (typeof Storage !== 'undefined') {
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    localStorage.removeItem(key);
                    log('清除 localStorage: ' + key);
                });
            }
            
            // 清除 sessionStorage
            if (typeof Storage !== 'undefined') {
                const keys = Object.keys(sessionStorage);
                keys.forEach(key => {
                    sessionStorage.removeItem(key);
                    log('清除 sessionStorage: ' + key);
                });
            }
            
            log('3秒后重新加载页面...');
            setTimeout(() => {
                window.location.reload(true);
            }, 3000);
        }
        
        // 页面加载时自动检查
        window.addEventListener('load', function() {
            setTimeout(() => {
                log('=== 页面加载完成，开始自动诊断 ===');
                checkUserStatus();
                checkRoutes();
            }, 2000);
        });
        
        // 监听路由变化
        window.addEventListener('hashchange', function() {
            log('Hash 变化: ' + window.location.hash);
        });
        
        // 监听 Vue 路由变化
        setTimeout(() => {
            try {
                const app = document.querySelector('#app').__vue__;
                app.$router.beforeEach((to, from, next) => {
                    log('Vue 路由变化: ' + from.path + ' -> ' + to.path);
                    next();
                });
            } catch (e) {
                console.log('无法监听 Vue 路由变化:', e);
            }
        }, 3000);
    </script>
    
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { margin: 5px; padding: 10px; }
        #results { 
            background: #f5f5f5; 
            padding: 10px; 
            margin: 20px 0; 
            max-height: 400px; 
            overflow-y: auto;
            border: 1px solid #ddd;
        }
    </style>
</body>
</html>
