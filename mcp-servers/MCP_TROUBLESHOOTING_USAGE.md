# MCP 故障排除功能使用指南

## 概述

我已经成功将504网关超时问题的故障排除经验集成到MCP项目重启服务器中。现在你可以通过AI助理直接使用自动化的故障诊断和修复功能。

## 新增功能

### 故障排除工具
- **工具名称**: `troubleshoot_gateway_timeout`
- **功能**: 自动诊断和解决504网关超时问题
- **集成位置**: `project-restart` MCP服务器

### 参数配置
```json
{
  "auto_fix": true,        // 是否自动尝试修复问题
  "check_config": true     // 是否检查前端代理配置
}
```

## 使用方法

### 通过AI助理使用

你可以直接对我说：

1. **自动诊断和修复**：
   ```
   "请诊断504网关超时问题"
   "请自动修复网关超时问题"
   "帮我解决前端代理超时问题"
   ```

2. **仅诊断不修复**：
   ```
   "请诊断网关超时问题，但不要自动修复"
   ```

3. **跳过配置检查**：
   ```
   "请诊断504问题，但不检查配置文件"
   ```

## 自动化诊断流程

### 1. 后端服务检查
- 测试后端API直接访问 (`http://localhost:8086/api/website`)
- 验证后端服务响应状态
- 检查后端进程是否运行

### 2. 前端代理检查
- 测试前端代理访问 (`http://localhost:8080/api/website`)
- 识别504超时错误
- 检查前端进程状态

### 3. 配置文件验证
- 读取前端代理配置 (`/home/metaspeekoj/OnlineJudgeFE/config/index.js`)
- 检查目标端口是否正确 (应为8086)
- 识别常见配置错误 (如指向8000端口)

### 4. 进程状态检查
- 验证Django后端进程
- 验证Vue.js前端进程
- 检查Redis服务状态

## 自动修复功能

### 配置修复
- 自动修正错误的代理端口配置
- 将 `localhost:8000` 替换为 `localhost:8086`
- 保持其他配置不变

### 服务重启
- 重启后端服务（如果需要）
- 重启前端服务以应用新配置
- 等待服务完全启动

### 修复验证
- 重新测试API连通性
- 确认504错误是否解决
- 生成修复结果报告

## 诊断报告示例

```
=== 504网关超时问题诊断开始 ===

1. 检查后端服务状态...
2. 检查前端代理状态...
3. 检查前端代理配置...
4. 检查服务进程状态...

=== 自动修复开始 ===
执行修复: 修正前端代理配置
配置修复: 成功

重启前端服务以应用配置...

=== 修复后验证 ===
验证结果: ✓ 问题已解决

=== 诊断结果 ===
后端服务 (8086): ✓ 正常
前端代理 (8080): ✓ 正常
代理配置: ✓ 正确 (8086)
后端进程: ✓ 运行中
前端进程: ✓ 运行中

参考文档: /home/metaspeekoj/mcp-servers/GATEWAY_TIMEOUT_TROUBLESHOOTING.md
```

## 技术实现

### MCP集成优势
- **智能诊断**: 系统化的问题检查流程
- **自动修复**: 无需手动干预的问题解决
- **实时验证**: 修复后立即验证结果
- **详细报告**: 完整的诊断和修复记录

### 核心功能
1. **executeCommand**: 执行系统命令和API测试
2. **fixProxyConfig**: 自动修复前端代理配置
3. **服务重启**: 集成现有的服务管理功能
4. **状态验证**: 实时检查修复效果

## 文件结构

```
/home/metaspeekoj/mcp-servers/
├── project_restart_mcp_server.js          # 主MCP服务器（已更新）
├── GATEWAY_TIMEOUT_TROUBLESHOOTING.md     # 详细故障排除指南
├── MCP_TROUBLESHOOTING_USAGE.md          # 本使用说明
└── PROJECT_RESTART_MCP_USAGE.md          # 项目重启功能说明
```

## 故障排除

### 如果自动修复失败
1. 检查文件权限：
   ```bash
   ls -la /home/metaspeekoj/OnlineJudgeFE/config/index.js
   ```

2. 手动检查配置：
   ```bash
   grep -n "target:" /home/metaspeekoj/OnlineJudgeFE/config/index.js
   ```

3. 查看详细日志：
   ```bash
   tail -f /tmp/frontend.log
   tail -f /tmp/backend.log
   ```

### 如果诊断工具无响应
1. 检查MCP服务器状态
2. 重启MCP服务器：
   ```bash
   pkill -f project_restart_mcp_server.js
   cd /home/metaspeekoj/mcp-servers
   node project_restart_mcp_server.js
   ```

## 最佳实践

1. **定期诊断**: 在遇到问题时立即使用诊断功能
2. **自动修复**: 优先使用自动修复，减少手动操作
3. **验证结果**: 修复后验证功能是否正常
4. **保留日志**: 查看详细的诊断报告以了解问题根因

## 扩展功能

未来可以扩展的功能：
- 数据库连接问题诊断
- 性能问题分析
- 安全配置检查
- 依赖包版本冲突检测

---

**状态**: ✅ 已部署并集成到MCP
**最后更新**: 2025年9月2日
**版本**: 1.0.0
**维护者**: AI Assistant

## 总结

通过将故障排除经验集成到MCP服务器中，现在可以：
1. 通过自然语言直接请求故障诊断
2. 自动化执行复杂的问题排查流程
3. 智能修复常见的配置问题
4. 获得详细的诊断和修复报告

这实现了真正的"智能化运维"，让问题解决变得更加高效和可靠！