<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>插入排序动画演示 —— 元探索柳老师</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-transition {
                transition: all 0.3s ease;
            }
            .sorting-card {
                @apply card-transition flex items-end justify-center text-white font-bold rounded-t-md shadow-md;
            }
            .pointer-i {
                @apply absolute -top-6 text-yellow-500 font-bold text-lg;
            }
            .pointer-j {
                @apply absolute -top-6 text-red-500 font-bold text-lg;
            }
            .code-line {
                @apply px-2 py-1 rounded-md transition-all duration-300;
            }
            .code-line-highlight {
                @apply bg-yellow-200 font-bold;
            }
            .btn-primary {
                @apply bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition-all duration-200;
            }
            .btn-secondary {
                @apply bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition-all duration-200;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center mb-8 text-blue-700">插入排序动画演示</h1>
        <div class="text-center text-sm text-gray-600 mb-6">元探索柳老师</div>

        <!-- 控制面板 -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <label for="inputArray" class="block text-gray-700 font-medium mb-2">输入数组（数字用逗号分隔）:</label>
                <input type="text" id="inputArray" value="6,4,8,2,7" 
                       class="flex-1 border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
           <button id="resetBtn" class="px-4 py-2 bg-blue-500 text-white rounded-md"><i class="fa fa-refresh mr-1"></i> 重置</button>
                <button id="prevBtn" class="px-4 py-2 bg-gray-500 text-white rounded-md"><i class="fa fa-step-backward mr-1"></i> 上一步</button>
                <button id="nextBtn" class="px-4 py-2 bg-gray-500 text-white rounded-md"><i class="fa fa-step-forward mr-1"></i> 下一步</button>
                <button id="autoBtn" class="px-4 py-2 bg-green-500 text-white rounded-md"><i class="fa fa-play mr-1"></i> 自动演示</button>
                <div class="speed-control flex items-center gap-2">
                    <span>速度:</span>
                    <input type="range" id="speedControl" min="100" max="2000" value="500" step="100" class="w-32">
                    <span id="speedValue" class="w-12 text-center">500ms</span>
                </div>
           
            </div>


        </div>
        <!-- 日志区域 -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div id="logContainer" class="bg-gray-100 rounded-md p-4 h-[50px] overflow-y-auto">
                <p class="text-gray-600">等待排序开始...</p>
            </div>
        </div>
        <!-- 主要展示区域 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- 左侧：柱状图展示 -->
            <div class="bg-white rounded-lg shadow-lg p-6 h-[500px]">
                <h2 class="text-xl font-bold text-gray-700 mb-4">排序过程可视化</h2>
                <div id="arrayContainer" class="flex items-end justify-center h-[400px] gap-2 relative">
                    <!-- 柱状图将在这里动态生成 -->
                </div>
            </div>
            
            <!-- 右侧：代码展示 -->
            <div class="bg-white rounded-lg shadow-lg p-6 h-[500px]">
                <h2 class="text-xl font-bold text-gray-700 mb-4">插入排序代码</h2>
                <div id="codeContainer" class="bg-gray-800 text-white rounded-md p-4 h-[400px] overflow-y-auto">
                    <pre id="codeDisplay" class="text-sm font-mono leading-relaxed">
// 插入排序算法 C++ 实现
void insertionSort(int arr[], int n) {
    for (int i = 1; i < n; i++) {
        int key = arr[i];
        int j = i - 1;
        
        // 将大于key的元素向右移动
        while (j >= 0 && arr[j] > key) {
            arr[j + 1] = arr[j];
            j--;
        }
        
        // 插入key到正确位置
        arr[j + 1] = key;
    }
}
                    </pre>
                </div>
            </div>
        </div>

        
    </div>

    <script>
        // 初始化变量
        let values = [];
        let bars = [];
        let i = 1, j = 0, key = 0;
        let stepState = "init";
        let autoTimer = null;
        let redIndex = -1;
        let blueIndex = -1;
        let roundStep = 0;
        let highlightSubState = "start";
        let history = [];

        // DOM 元素缓存
        const dom = {
            inputArray: document.getElementById('inputArray'),
            resetBtn: document.getElementById('resetBtn'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),
            autoBtn: document.getElementById('autoBtn'),
            speedControl: document.getElementById('speedControl'),
            speedValue: document.getElementById('speedValue'),
            arrayContainer: document.getElementById('arrayContainer'),
            codeDisplay: document.getElementById('codeDisplay'),
            logContainer: document.getElementById('logContainer')
        };

        // C++ 代码行数组
        const cppCode = [
            '#include <iostream>',
            'using namespace std;',
            '',
            'void insertionSort(int arr[], int n) {',
            '    for (int i = 1; i < n; i++) {',
            '        int key = arr[i];     // 当前待插入的元素',
            '        int j = i - 1;',
            '        // 向左寻找插入位置',
            '        while (j >= 0 && arr[j] > key) {',
            '            arr[j + 1] = arr[j];  // 元素右移',
            '            j--;',
            '        }',
            '        arr[j + 1] = key;  // 插入到正确位置',
            '    }',
            '}'
        ];

        // 更新速度显示
        dom.speedControl.addEventListener('input', () => {
            dom.speedValue.textContent = `${dom.speedControl.value}ms`;
        });

        // 重置按钮事件
        dom.resetBtn.addEventListener('click', resetBars);
        dom.prevBtn.addEventListener('click', prevStep);
        dom.nextBtn.addEventListener('click', nextStep);
        dom.autoBtn.addEventListener('click', autoRun);

        function showCode() {
            dom.codeDisplay.innerHTML = '';
            cppCode.forEach(line => {
                const div = document.createElement('div');
                div.className = 'code-line';
                div.textContent = line;
                dom.codeDisplay.appendChild(div);
            });
        }

        function highlightCode(lineIndex) {
            for(let k = 0; k < dom.codeDisplay.children.length; k++) {
                dom.codeDisplay.children[k].classList.toggle('code-line-highlight', k === lineIndex);
            }
        }

        function clearCodeHighlight() {
            [...dom.codeDisplay.children].forEach(div => div.classList.remove('code-line-highlight'));
        }

        function createBar(value, index) {
            const div = document.createElement("div");
            div.className = "sorting-card flex-shrink-0";
            div.style.width = `80px`;
            div.style.height = `${value * 40}px`;
            div.dataset.index = index;
            div.textContent = value;
            return div;
        }

        function updateColors() {
            for(let k = 0; k < values.length; k++) {
                setColor(k, k < i ? 'bg-green-500' : 'bg-blue-500');
            }
            if(redIndex >= 0) setColor(redIndex, 'bg-yellow-500');
            if(blueIndex >= 0 && blueIndex !== redIndex) setColor(blueIndex, 'bg-red-500');
        }

        function setColor(idx, color) {
            if(bars[idx]) {
                bars[idx].className = `sorting-card flex-shrink-0 ${color}`;
            }
        }

        function drawMarkers() {
            bars.forEach((bar, idx) => {
                bar.querySelectorAll('.marker').forEach(e => e.remove());
                if(idx === redIndex) {
                    const marker = document.createElement("div");
                    marker.className = "pointer-i marker";
                    marker.innerHTML = '<i class="fa fa-arrow-up"></i> i';
                    bar.appendChild(marker);
                }
                if(idx === blueIndex) {
                    const marker = document.createElement("div");
                    marker.className = "pointer-j marker";
                    marker.innerHTML = '<i class="fa fa-arrow-up"></i> j';
                    bar.appendChild(marker);
                }
            });
        }

        function redraw() {
            dom.arrayContainer.innerHTML = "";
            bars = values.map((val, idx) => createBar(val, idx));
            bars.forEach(bar => dom.arrayContainer.appendChild(bar));
        }

        function updateLog(msg) {
            const logEntry = document.createElement('p');
            logEntry.className = 'mb-1';
            logEntry.textContent = msg;
            dom.logContainer.appendChild(logEntry);
            dom.logContainer.scrollTop = dom.logContainer.scrollHeight;
        }

        function saveState() {
            const state = {
                values: values.slice(),
                i, j, key, stepState, redIndex, blueIndex, roundStep, highlightSubState
            };
            history.push(state);
        }

        function loadState(state) {
            values = state.values.slice();
            i = state.i;
            j = state.j;
            key = state.key;
            stepState = state.stepState;
            redIndex = state.redIndex;
            blueIndex = state.blueIndex;
            roundStep = state.roundStep;
            highlightSubState = state.highlightSubState;
            redraw();
            updateColors();
            drawMarkers();
            updateLog(`恢复状态：i=${i}, j=${j}, key=${key}`);
            highlightCodeByState();
        }

        function highlightCodeByState() {
            clearCodeHighlight();
            if(stepState === "init") {
                highlightCode(5);
            } else if(stepState === "compare") {
                if(highlightSubState === "start") highlightCode(8);
                else if(highlightSubState === "move") highlightCode(9);
                else if(highlightSubState === "j--") highlightCode(10);
                else if(highlightSubState === "done") highlightCode(11);
            } else if(stepState === "insert") {
                highlightCode(12);
            }
        }

        function resetBars() {
            clearInterval(autoTimer);
            history = [];
            const input = dom.inputArray.value.trim();
            if (input === '') {
                updateLog('错误：请输入有效的数组');
                return;
            }
            try {
                values = input.split(',').map(num => parseInt(num.trim())).filter(num => !isNaN(num));
                if (values.length === 0) {
                    updateLog('错误：请输入有效的数字数组');
                    return;
                }
                if (values.length > 10) {
                    updateLog('错误：数组长度不能超过10个元素');
                    return;
                }
            } catch (e) {
                updateLog('错误：数组格式不正确');
                return;
            }
            i = 1;
            j = 0;
            stepState = "init";
            redIndex = -1;
            blueIndex = -1;
            roundStep = 0;
            highlightSubState = "start";
            redraw();
            updateColors();
            drawMarkers();
            updateLog("点击“下一步”开始演示");
            clearCodeHighlight();
            saveState();
        }

        function nextStep() {
            if(i >= values.length) {
                updateLog("排序完成 ✅");
                for(let k=0; k<values.length; k++) setColor(k, 'bg-green-500');
                drawMarkers();
                clearCodeHighlight();
                return;
            }
            switch(stepState) {
                case "init":
                    key = values[i];
                    j = i - 1;
                    redIndex = i;
                    blueIndex = j;
                    roundStep = 0;
                    highlightSubState = "start";
                    updateLog(`准备插入第 ${i + 1} 张牌：${key}`);
                    drawMarkers();
                    updateColors();
                    highlightCode(5);
                    stepState = "compare";
                    break;
                case "compare":
                    roundStep++;
                    if(j >= 0 && values[j] > key) {
                        if (highlightSubState === "start") {
                            highlightCode(8);
                            highlightSubState = "move";
                        } else if (highlightSubState === "move") {
                            highlightCode(9);
                            updateLog(`第 ${j + 1} 张 ${values[j]} > ${key}，右移`);
                            values[j + 1] = values[j];
                            redraw();
                            drawMarkers();
                            updateColors();
                            highlightSubState = "j--";
                        } else if (highlightSubState === "j--") {
                            highlightCode(10);
                            j--;
                            blueIndex = j;
                            drawMarkers();
                            highlightSubState = "start";
                        }
                    } else {
                        if (highlightSubState !== "done") {
                            highlightCode(11);
                            updateLog(`j 越界或不满足条件：j=${j}`);
                            highlightSubState = "done";
                        } else {
                            stepState = "insert";
                            highlightSubState = "start";
                        }
                    }
                    break;
                case "insert":
                    highlightCode(12);
                    values[j + 1] = key;
                    updateLog(`将 ${key} 插入到位置 ${j + 2}`);
                    redraw();
                    drawMarkers();
                    updateColors();
                    i++;
                    stepState = "init";
                    break;
            }
        }

        function prevStep() {
            if(history.length <= 1) {
                updateLog("已经是初始状态，不能再退回。");
                return;
            }
            clearInterval(autoTimer);
            history.pop();
            const prevState = history[history.length - 1];
            loadState(prevState);
        }

        function autoRun() {
            const speed = parseInt(dom.speedControl.value);
            clearInterval(autoTimer);
            if (dom.autoBtn.innerHTML.includes('fa-play')) {
                dom.autoBtn.innerHTML = '<i class="fa fa-pause mr-1"></i> 暂停';
                autoTimer = setInterval(() => {
                    nextStep();
                    if(i >= values.length && stepState === "init") {
                        clearInterval(autoTimer);
                        dom.autoBtn.innerHTML = '<i class="fa fa-play mr-1"></i> 自动演示';
                        clearCodeHighlight();
                    }
                }, speed);
            } else {
                dom.autoBtn.innerHTML = '<i class="fa fa-play mr-1"></i> 自动演示';
            }
        }

        // 初始化页面
        showCode();
        resetBars();
    </script>
</body>
</html>
    